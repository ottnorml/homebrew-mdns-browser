name: Auto bump Formulas and Casks

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

concurrency:
  group: autobump-${{ github.repository }}
  cancel-in-progress: false

jobs:
  autobump:
    runs-on: macos-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@0fd01fffe2bb7ba090ade9655fe7e89ab5c613d4 # 2025-10-31, no tagged version
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get packages to bump in this repository
        id: packages
        shell: bash
        run: |
          set -euo pipefail

          # GitHub Actions sets this automatically.
          # Fallback for local runs so the script doesn't error.
          : "${GITHUB_OUTPUT:=/dev/stdout}"

          list_rb_basename_sorted() {
            local dir="$1"
            [[ -d "$dir" ]] || return 0
            find "$dir" -maxdepth 1 -type f -name '*.rb' -print \
              | sed 's|.*/||; s|\.rb$||' \
              | sort
          }

          formulae="$(list_rb_basename_sorted "Formula")"
          casks="$(list_rb_basename_sorted "Casks")"

          {
            echo "formulae<<EOF"
            echo "$formulae"
            echo "EOF"
            echo "casks<<EOF"
            echo "$casks"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Clean up stale bump branches
        shell: bash
        run: |
          set +e  # Don't exit on error for this step

          # Get list of remote branches matching bump-* pattern
          BUMP_BRANCHES=$(git ls-remote --heads origin 'bump-*' | awk '{print $2}' | sed 's|refs/heads/||' || true)

          if [[ -n "$BUMP_BRANCHES" ]]; then
            echo "Found stale bump branches to clean up:"
            echo "$BUMP_BRANCHES"

            # Delete each bump branch from remote
            while IFS= read -r branch; do
              branch=$(echo "$branch" | xargs)  # Trim whitespace
              if [[ -n "$branch" ]]; then
                echo "Deleting remote branch: $branch"
                git push origin --delete "$branch" || echo "Failed to delete $branch (may already be gone)"
              fi
            done <<< "$BUMP_BRANCHES"
          else
            echo "No stale bump branches found"
          fi

      - name: Bump packages
        uses: Homebrew/actions/bump-packages@876ff924bd08a9cb5f3cc6bc581054d6f545d0d5 # 2025-04-01, no tagged version
        with:
          # Token used to open PRs. GITHUB_TOKEN is sufficient for same-repo PRs.
          token: ${{ secrets.GITHUB_TOKEN }}
          formulae: ${{ steps.packages.outputs.formulae }}
          casks: ${{ steps.packages.outputs.casks }}
          fork: false
